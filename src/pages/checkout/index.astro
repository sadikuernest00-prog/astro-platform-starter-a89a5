---
const base = import.meta.env.BASE_URL;
const vippsQr = `${base}images/vipps-qr.png`; // put file in /public/images/
const whatsappNumber = "4792928373"; // your number (from your header)
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Checkout</title>
    <style>
      body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; padding:24px; max-width:900px; margin:0 auto; }
      .box{ border:1px solid #ddd; padding:16px; margin:16px 0; }
      .row{ display:flex; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px solid #eee; }
      .muted{ color:#666; }
      img{ max-width:260px; border:1px solid #ddd; }
      input{ width:100%; padding:12px; border:1px solid #ddd; margin-top:8px; }
      button{ padding:12px 14px; font-weight:700; cursor:pointer; border:1px solid #111; background:#111; color:#fff; }
      a{ color:#111; }
    </style>
  </head>
  <body>
    <a href={`${base}`}>← Back to shop</a>
    <h1>Checkout</h1>

    <div class="box">
      <h2>1) Your order</h2>
      <div id="items"></div>
      <p class="muted" id="total"></p>
    </div>

    <div class="box">
      <h2>2) Pay with Vipps (Privat)</h2>
      <p class="muted">Scan this QR code in Vipps and pay the total amount.</p>
      <img src={vippsQr} alt="Vipps QR code" />
      <p class="muted" id="payHint"></p>
    </div>

    <div class="box">
      <h2>3) Send proof / details</h2>
      <label>
        Your Vipps name or phone number
        <input id="vippsId" placeholder="e.g. +47 900 00 000 or your name in Vipps" />
      </label>

      <p class="muted">
        After you pay, click the button below. It will open WhatsApp with your order details.
      </p>

      <button id="send">I have paid – send order</button>
      <p class="muted" id="msg"></p>
    </div>

    <script>
      const CART_KEY = "amicbridge_cart_v1";

      function readCart() {
        try { return JSON.parse(localStorage.getItem(CART_KEY) || "[]"); }
        catch { return []; }
      }

      function calcTotal(cart){
        return cart.reduce((s, i) => s + (Number(i.price)||0) * (Number(i.qty)||0), 0);
      }

      function render(){
        const cart = readCart();
        const itemsEl = document.getElementById("items");
        const totalEl = document.getElementById("total");
        const payHint = document.getElementById("payHint");

        if(!cart.length){
          itemsEl.innerHTML = "<p>Your cart is empty.</p>";
          totalEl.textContent = "";
          payHint.textContent = "";
          return;
        }

        itemsEl.innerHTML = cart.map(i => `
          <div class="row">
            <div>
              <div><b>${i.name}</b></div>
              <div class="muted">Size: ${i.size} • Color: ${i.color} • Qty: ${i.qty}</div>
            </div>
            <div>${i.price * i.qty} NOK</div>
          </div>
        `).join("");

        const total = calcTotal(cart);
        totalEl.textContent = `Total: ${total} NOK`;
        payHint.textContent = `Pay exactly: ${total} NOK`;
      }

      render();

      document.getElementById("send").addEventListener("click", () => {
        const msgEl = document.getElementById("msg");
        const cart = readCart();
        if(!cart.length){
          msgEl.textContent = "Cart is empty.";
          return;
        }

        const vippsId = (document.getElementById("vippsId").value || "").trim();
        if(!vippsId){
          msgEl.textContent = "Please enter your Vipps name or phone number.";
          return;
        }

        const total = cart.reduce((s, i) => s + (Number(i.price)||0)*(Number(i.qty)||0), 0);

        const orderLines = cart.map(i =>
          `- ${i.name} | ${i.size} | ${i.color} | qty ${i.qty} | ${i.price} NOK`
        ).join("%0A");

        const orderId = `AMIC-${Date.now()}`; // simple unique id

        const text =
          `New order: ${orderId}%0A` +
          `Vipps payer: ${encodeURIComponent(vippsId)}%0A` +
          `Total paid: ${total} NOK%0A%0A` +
          `Items:%0A${orderLines}%0A%0A` +
          `Delivery info (write here):`;

        const url = `https://wa.me/${whatsappNumber}?text=${text}`;
        window.open(url, "_blank");

        msgEl.textContent = "Opened WhatsApp. Please send the message to confirm your order.";
      });
    </script>
  </body>
</html>
