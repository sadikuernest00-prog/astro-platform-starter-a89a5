---
const base = import.meta.env.BASE_URL;
const FORMSPREE_ACTION = "https://formspree.io/f/xzznjkvd";
---

<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout — Amicbridge</title>
  <style>
    body{margin:0;font-family:system-ui;background:#f7f6f4;color:#151515}
    header{padding:24px 40px;display:flex;justify-content:space-between;align-items:center}
    main{max-width:1000px;margin:0 auto;padding:0 40px 60px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card{background:#fff;border:1px solid #dedede;padding:16px}
    label{font-size:12px;color:#6b6b6b;text-transform:uppercase;letter-spacing:.06em}
    input,textarea{width:100%;padding:12px;border:1px solid #dedede;margin-top:6px}
    textarea{min-height:90px}
    .btn{padding:14px 12px;border:1px solid #151515;background:#151515;color:#fff;cursor:pointer;font-weight:700}
    .muted{color:#6b6b6b}
    .item{display:flex;justify-content:space-between;border-top:1px solid #dedede;padding-top:10px;margin-top:10px}
    .total{display:flex;justify-content:space-between;border-top:1px solid #dedede;padding-top:12px;margin-top:12px;font-weight:800}
    .error{color:#b42318;font-size:13px;margin-top:10px;display:none}
    @media (max-width:900px){header{padding:18px}main{padding:0 18px 40px}.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <strong style="letter-spacing:.08em;">AMICBRIDGE</strong>
    <a href={`${base}`}>← Back</a>
  </header>

  <main>
    <h1>Checkout</h1>
    <p class="muted">Fill in shipping details and send your order. We will receive it by email.</p>

    <div class="grid">
      <section class="card">
        <h2 style="margin:0 0 10px;font-size:18px;">Shipping details</h2>

        <form id="orderForm" action={FORMSPREE_ACTION} method="POST">
          <!-- hidden fields filled by JS -->
          <input type="hidden" name="order_summary" id="order_summary" />
          <input type="hidden" name="order_total_nok" id="order_total_nok" />
          <input type="hidden" name="order_items_json" id="order_items_json" />
          <input type="hidden" name="_subject" value="New Amicbridge order" />
          <input type="hidden" name="_format" value="plain" />

          <div style="margin-top:10px">
            <label>Full name</label>
            <input name="full_name" required />
          </div>

          <div style="margin-top:10px">
            <label>Email</label>
            <input name="email" type="email" required />
          </div>

          <div style="margin-top:10px">
            <label>Phone</label>
            <input name="phone" required />
          </div>

          <div style="margin-top:10px">
            <label>Address</label>
            <input name="address" required />
          </div>

          <div style="margin-top:10px">
            <label>City</label>
            <input name="city" required />
          </div>

          <div style="margin-top:10px">
            <label>Postal code</label>
            <input name="postal_code" required />
          </div>

          <div style="margin-top:10px">
            <label>Country</label>
            <input name="country" value="Norway" required />
          </div>

          <div style="margin-top:10px">
            <label>Message (optional)</label>
            <textarea name="message"></textarea>
          </div>

          <button class="btn" type="submit" style="margin-top:14px">Send order</button>

          <div class="error" id="cartError">Your cart is empty. Go back and add products.</div>
        </form>
      </section>

      <aside class="card">
        <h2 style="margin:0 0 10px;font-size:18px;">Order summary</h2>
        <div id="items"></div>
        <div class="total">
          <span>Total</span>
          <span><span id="total">0</span> NOK</span>
        </div>
      </aside>
    </div>
  </main>

  <script>
    const CART_KEY = "amicbridge_cart_v1";

    function readCart() {
      try { return JSON.parse(localStorage.getItem(CART_KEY) || "[]"); }
      catch { return []; }
    }

    const cart = readCart();
    const itemsEl = document.getElementById("items");
    const totalEl = document.getElementById("total");
    const cartError = document.getElementById("cartError");
    const form = document.getElementById("orderForm");

    let total = 0;
    itemsEl.innerHTML = "";

    cart.forEach((item) => {
      const qty = Number(item.qty || 0);
      const price = Number(item.price || 0);
      const line = qty * price;
      total += line;

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div>
          <strong>${item.name}</strong><br/>
          <span class="muted">Size: ${item.size || "-"} · Color: ${item.color || "-"}</span><br/>
          <span class="muted">Qty: ${qty}</span>
        </div>
        <div><strong>${line} NOK</strong></div>
      `;
      itemsEl.appendChild(div);
    });

    totalEl.textContent = String(total);

    // Hidden fields for Formspree email
    const summaryLines = cart.map((i) =>
      `${i.name} | Qty: ${i.qty} | Size: ${i.size} | Color: ${i.color} | Price: ${i.price} NOK`
    );

    document.getElementById("order_summary").value = summaryLines.join("\\n");
    document.getElementById("order_total_nok").value = String(total);
    document.getElementById("order_items_json").value = JSON.stringify(cart, null, 2);

    if (!cart.length) {
      cartError.style.display = "block";
      form.addEventListener("submit", (e) => e.preventDefault());
    }
  </script>
</body>
</html>

