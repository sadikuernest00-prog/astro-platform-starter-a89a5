
---
const base = import.meta.env.BASE_URL;
const FORMSPREE_ACTION = "https://formspree.io/f/xzznjkvd";

// helper: always build correct URL (works on / and subfolders)
const img = (path) => `${base}${String(path || "").replace(/^\/+/, "")}`;
---

<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout — Amicbridge</title>

  <style>
    :root{
      --bg:#f7f6f4; --text:#151515; --muted:#6b6b6b; --border:#dedede; --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:24px 40px;display:flex;justify-content:space-between;align-items:center}
    a{color:var(--text);text-decoration:none}
    a:hover{text-decoration:underline}
    main{max-width:1100px;margin:0 auto;padding:0 40px 70px}
    h1{margin:16px 0 8px;font-size:34px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:start;margin-top:18px}
    .card{background:var(--card);border:1px solid var(--border);padding:16px}
    label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
    input,textarea{width:100%;padding:12px;border:1px solid var(--border);margin-top:6px;font-size:15px}
    textarea{min-height:90px;resize:vertical}
    .btn{padding:14px 12px;border:1px solid var(--text);background:var(--text);color:#fff;cursor:pointer;font-weight:700;width:100%}
    .btn.secondary{background:#fff;color:var(--text);border-color:var(--border);font-weight:600}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .error{color:#b42318;font-size:13px;margin-top:10px;display:none}
    .ok{color:#1a7f37;font-size:13px;margin-top:10px;display:none}

    .items{display:flex;flex-direction:column;gap:12px;margin-top:10px}
    .item{
      border-top:1px solid var(--border);
      padding-top:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
    }
    .item:first-child{border-top:0;padding-top:0}
    .item strong{display:block;font-size:16px;margin-bottom:4px}
    .meta{color:var(--muted);font-size:13px;line-height:1.35}
    .controls{
      display:flex; flex-direction:column; gap:8px; align-items:flex-end;
      min-width: 160px;
    }
    .qty{
      display:grid;
      grid-template-columns: 36px 44px 36px;
      border:1px solid var(--border);
      background:#fff;
    }
    .qty button{
      border:0;background:#fff;cursor:pointer;font-size:18px;padding:8px 0;
    }
    .qty div{
      display:flex;align-items:center;justify-content:center;font-weight:700;
      border-left:1px solid var(--border);border-right:1px solid var(--border);
    }
    .price{font-weight:800}
    .thumb{width:54px;height:54px;border:1px solid var(--border);background:#fff;object-fit:cover}
    .leftline{display:flex;gap:12px}
    .totals{margin-top:12px;border-top:1px solid var(--border);padding-top:12px}
    .totalsRow{display:flex;justify-content:space-between;margin:6px 0}
    .totalsRow strong{font-size:18px}
    .stack{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .small{font-size:12px;color:var(--muted);line-height:1.4}

    /* Vipps box */
    .vippsBox{
      border:1px solid var(--border);
      background:#fff;
      padding:14px;
    }
    .vippsNumber{
      font-size:24px;
      font-weight:800;
      margin:6px 0 10px;
      letter-spacing:.02em;
    }
    .pillrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .pill{
      border:1px solid var(--border);
      padding:10px 12px;
      background:#fff;
      cursor:pointer;
      font-weight:700;
    }

    @media (max-width: 900px){
      header{padding:18px 18px}
      main{padding:0 18px 56px}
      .grid{grid-template-columns:1fr}
      .controls{align-items:stretch}
    }
  </style>
</head>

<body>
  <header>
    <a href={base}>← Back to shop</a>
    <a href={base} class="muted">Amicbridge</a>
  </header>

  <main>
    <h1>Checkout</h1>
    <div class="muted">Enter your details, review your order, then pay with Vipps.</div>

    <div class="grid">
      <!-- LEFT: customer details -->
      <section class="card">
        <h2 style="margin:0 0 10px;font-size:18px">Customer details</h2>

        <form id="detailsForm" action={FORMSPREE_ACTION} method="POST">
          <div class="row2">
            <div>
              <label for="name">Full name</label>
              <input id="name" name="name" autocomplete="name" required />
            </div>
            <div>
              <label for="email">Email</label>
              <input id="email" name="email" type="email" autocomplete="email" required />
            </div>
          </div>

          <div style="margin-top:12px">
            <label for="address">Address</label>
            <input id="address" name="address" autocomplete="street-address" required />
          </div>

          <div class="row2" style="margin-top:12px">
            <div>
              <label for="city">City</label>
              <input id="city" name="city" autocomplete="address-level2" required />
            </div>
            <div>
              <label for="zip">ZIP / Postal code</label>
              <input id="zip" name="zip" autocomplete="postal-code" required />
            </div>
          </div>

          <div style="margin-top:12px">
            <label for="notes">Order notes (optional)</label>
            <textarea id="notes" name="notes" placeholder="Size requests, delivery notes, etc."></textarea>
          </div>

          <!-- Hidden fields sent to Formspree -->
          <input type="hidden" id="cartSummary" name="cartSummary" value="" />
          <input type="hidden" id="orderTotal" name="orderTotal" value="" />
        </form>

        <div class="small" style="margin-top:12px">
          Payment is made in Vipps. After you pay, click “Send order details” so we can match your payment to your order.
        </div>
      </section>

      <!-- RIGHT: order summary -->
      <aside class="card">
        <h2 style="margin:0 0 10px;font-size:18px">Your order</h2>

        <div id="emptyCart" class="muted" style="display:none;margin-top:6px">
          Your cart is empty. Go back and add items.
        </div>

        <div id="items" class="items"></div>

        <div class="totals" id="totals" style="display:none">
          <div class="totalsRow">
            <span class="muted">Subtotal</span>
            <span id="subtotal">0</span>
          </div>
          <div class="totalsRow">
            <span class="muted">Shipping</span>
            <span id="shipping">Agree in message</span>
          </div>
          <div class="totalsRow">
            <strong>Total</strong>
            <strong id="total">0</strong>
          </div>

          <div class="stack">
            <!-- VIPPS PAYMENT BOX -->
            <div class="vippsBox">
              <div style="font-weight:800;margin-bottom:4px">Pay with Vipps (Private)</div>
              <div class="meta">Send the total amount to Vipps number:</div>
              <div class="vippsNumber" id="vippsNumber">92928373</div>

              <div class="meta">
                Message: <strong>Your name + product</strong>
              </div>

              <div class="pillrow">
                <button class="pill" id="copyVipps" type="button">Copy number</button>
                <button class="pill" id="copyTotal" type="button">Copy total</button>
              </div>

              <div class="small" style="margin-top:10px">
                After paying in Vipps, click <strong>Send order details</strong> below.
              </div>
            </div>

            <!-- SEND ORDER DETAILS -->
            <button class="btn secondary" id="sendBtn" type="button">Send order details</button>

            <p class="error" id="payErr"></p>
            <p class="ok" id="okMsg"></p>

            <div class="small">
              This sends your details + cart to our inbox so we can confirm your Vipps payment and ship your order.
            </div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // ---------- helpers ----------
    const fmt = (n) => {
      const num = Number(n || 0);
      return new Intl.NumberFormat("en-US", { style: "currency", currency: "NOK" }).format(num);
    };

    function readCart() {
      try {
        const raw = localStorage.getItem("cart");
        const parsed = JSON.parse(raw || "[]");
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function writeCart(cart) {
      localStorage.setItem("cart", JSON.stringify(cart));
    }

    // ---------- UI elements ----------
    const elItems = document.getElementById("items");
    const elEmpty = document.getElementById("emptyCart");
    const elTotals = document.getElementById("totals");
    const elSubtotal = document.getElementById("subtotal");
    const elTotal = document.getElementById("total");

    const sendBtn = document.getElementById("sendBtn");
    const payErr = document.getElementById("payErr");
    const okMsg = document.getElementById("okMsg");

    const detailsForm = document.getElementById("detailsForm");
    const cartSummaryInput = document.getElementById("cartSummary");
    const orderTotalInput = document.getElementById("orderTotal");

    const copyVippsBtn = document.getElementById("copyVipps");
    const copyTotalBtn = document.getElementById("copyTotal");
    const vippsNumberEl = document.getElementById("vippsNumber");

    function calcSubtotal(cart) {
      return cart.reduce((sum, it) => sum + (Number(it.price || 0) * Number(it.quantity || 1)), 0);
    }

    function render() {
      const cart = readCart();

      if (!cart.length) {
        elEmpty.style.display = "block";
        elTotals.style.display = "none";
        elItems.innerHTML = "";
        cartSummaryInput.value = "[]";
        orderTotalInput.value = "0";
        return;
      }

      elEmpty.style.display = "none";
      elTotals.style.display = "block";

      elItems.innerHTML = cart.map((it, idx) => {
        const name = it.name || it.id || "Item";
        const qty = Number(it.quantity || 1);
        const size = it.size ? `Size: ${it.size}` : "";
        const color = it.color ? `Color: ${it.color}` : "";
        const meta = [size, color].filter(Boolean).join(" • ");
        const lineTotal = Number(it.price || 0) * qty;
        const image = it.image ? it.image : "";

        return `
          <div class="item" data-idx="${idx}">
            <div class="leftline">
              ${image ? `<img class="thumb" src="${image}" alt="${name}">` : `<div class="thumb"></div>`}
              <div>
                <strong>${name}</strong>
                <div class="meta">${meta || "—"}</div>
                <div class="meta">Unit: ${fmt(it.price || 0)}</div>
              </div>
            </div>

            <div class="controls">
              <div class="qty">
                <button type="button" data-act="dec" aria-label="Decrease">−</button>
                <div>${qty}</div>
                <button type="button" data-act="inc" aria-label="Increase">+</button>
              </div>
              <div class="price">${fmt(lineTotal)}</div>
              <button type="button" class="btn secondary" style="padding:10px 12px" data-act="remove">Remove</button>
            </div>
          </div>
        `;
      }).join("");

      const sub = calcSubtotal(cart);
      elSubtotal.textContent = fmt(sub);
      elTotal.textContent = fmt(sub);

      // Keep hidden fields updated (Formspree)
      cartSummaryInput.value = JSON.stringify(cart);
      orderTotalInput.value = String(sub);

      // Store total as text for copy button
      copyTotalBtn.dataset.totalText = fmt(sub);
      copyTotalBtn.dataset.totalNumber = String(sub);
    }

    elItems.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const itemEl = e.target.closest(".item");
      if (!itemEl) return;

      const idx = Number(itemEl.dataset.idx);
      const act = btn.dataset.act;

      const cart = readCart();
      if (!cart[idx]) return;

      if (act === "inc") cart[idx].quantity = Number(cart[idx].quantity || 1) + 1;
      if (act === "dec") cart[idx].quantity = Math.max(1, Number(cart[idx].quantity || 1) - 1);
      if (act === "remove") cart.splice(idx, 1);

      writeCart(cart);
      render();
    });

    async function copyText(text) {
      // Works on https (Netlify). If it fails, we show a small message.
      await navigator.clipboard.writeText(text);
    }

    copyVippsBtn?.addEventListener("click", async () => {
      payErr.style.display = "none";
      okMsg.style.display = "none";
      try {
        await copyText(vippsNumberEl.textContent.trim());
        okMsg.textContent = "Vipps number copied.";
        okMsg.style.display = "block";
      } catch {
        payErr.textContent = "Could not copy. Please copy manually: 92928373";
        payErr.style.display = "block";
      }
    });

    copyTotalBtn?.addEventListener("click", async () => {
      payErr.style.display = "none";
      okMsg.style.display = "none";
      const totalText = copyTotalBtn.dataset.totalText || "";
      if (!totalText) return;
      try {
        await copyText(totalText);
        okMsg.textContent = "Total copied.";
        okMsg.style.display = "block";
      } catch {
        payErr.textContent = "Could not copy total. Please copy manually from the Total above.";
        payErr.style.display = "block";
      }
    });

    // ---------- actions ----------
    sendBtn?.addEventListener("click", () => {
      payErr.style.display = "none";
      okMsg.style.display = "none";

      // validate required fields first
      if (!detailsForm.reportValidity()) return;

      const cart = readCart();
      if (!cart.length) {
        payErr.textContent = "Your cart is empty.";
        payErr.style.display = "block";
        return;
      }

      // Make sure hidden fields are current
      cartSummaryInput.value = JSON.stringify(cart);
      orderTotalInput.value = String(calcSubtotal(cart));

      detailsForm.submit();
      okMsg.textContent = "Order details sent. Please pay with Vipps if you haven’t already.";
      okMsg.style.display = "block";
    });

    // initial render
    render();
  </script>
</body>
</html>

