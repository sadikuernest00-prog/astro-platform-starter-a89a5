---
const base = import.meta.env.BASE_URL;
const FORMSPREE_ACTION = "https://formspree.io/f/xzznjkvd";
---

<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout — Amicbridge</title>

  <style>
    :root{
      --bg:#f7f6f4; --text:#151515; --muted:#6b6b6b; --border:#dedede; --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:24px 40px;display:flex;justify-content:space-between;align-items:center}
    a{color:var(--text);text-decoration:none}
    a:hover{text-decoration:underline}
    main{max-width:1100px;margin:0 auto;padding:0 40px 70px}
    h1{margin:16px 0 8px;font-size:34px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:start;margin-top:18px}
    .card{background:var(--card);border:1px solid var(--border);padding:16px}
    label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
    input,textarea{width:100%;padding:12px;border:1px solid var(--border);margin-top:6px;font-size:15px}
    textarea{min-height:90px;resize:vertical}
    .btn{padding:14px 12px;border:1px solid var(--text);background:var(--text);color:#fff;cursor:pointer;font-weight:700}
    .btn.secondary{background:#fff;color:var(--text);border-color:var(--border);font-weight:600}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .error{color:#b42318;font-size:13px;margin-top:10px;display:none}
    .ok{color:#1a7f37;font-size:13px;margin-top:10px;display:none}

    .items{display:flex;flex-direction:column;gap:12px;margin-top:10px}
    .item{
      border-top:1px solid var(--border);
      padding-top:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
    }
    .item:first-child{border-top:0;padding-top:0}
    .item strong{display:block;font-size:16px;margin-bottom:4px}
    .meta{color:var(--muted);font-size:13px;line-height:1.35}
    .controls{
      display:flex; flex-direction:column; gap:8px; align-items:flex-end;
      min-width: 140px;
    }
    .qty{
      display:grid;
      grid-template-columns: 36px 44px 36px;
      border:1px solid var(--border);
      background:#fff;
    }
    .qty button{
      border:0;background:#fff;cursor:pointer;font-size:18px;padding:8px 0;
    }
    .qty div{
      border-left:1px solid var(--border);
      border-right:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;font-size:14px;
    }
    .remove{
      padding:10px 10px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:600;
      width:100%;
    }
    .lineTotal{font-weight:800}
    .total{
      display:flex;justify-content:space-between;border-top:1px solid var(--border);
      padding-top:12px;margin-top:12px;font-weight:800;
    }

    .payBox{
      margin-top:12px;
      border-top:1px solid var(--border);
      padding-top:12px;
      display:grid;
      gap:10px;
    }
    .btn.vipps{
      background:#ff5b24;
      border-color:#ff5b24;
      color:#111;
      font-weight:800;
    }
    .small{font-size:12px;color:var(--muted);line-height:1.4}

    @media (max-width: 900px){
      header{padding:18px}
      main{padding:0 18px 50px}
      .grid{grid-template-columns:1fr}
      .controls{align-items:stretch}
    }
  </style>
</head>

<body>
  <header>
    <strong style="letter-spacing:.08em;">AMICBRIDGE</strong>
    <a href={`${base}`}>← Back</a>
  </header>

  <main>
    <h1>Checkout</h1>
    <p class="muted">Fill in shipping details and send your order. We will receive it by email.</p>

    <div class="grid">
      <!-- Shipping form -->
      <section class="card">
        <h2 style="margin:0 0 10px;font-size:18px;">Shipping details</h2>

        <form id="orderForm" action={FORMSPREE_ACTION} method="POST">
          <!-- Hidden fields filled by JS -->
          <input type="hidden" name="order_summary" id="order_summary" />
          <input type="hidden" name="order_total_nok" id="order_total_nok" />
          <input type="hidden" name="order_items_json" id="order_items_json" />

          <!-- Vipps info (filled by JS) -->
          <input type="hidden" name="vipps_status" id="vipps_status" value="not_started" />
          <input type="hidden" name="vipps_order_id" id="vipps_order_id" value="" />

          <input type="hidden" name="_subject" value="New Amicbridge order" />
          <input type="hidden" name="_format" value="plain" />

          <div style="margin-top:10px">
            <label>Full name</label>
            <input name="full_name" required />
          </div>

          <div style="margin-top:10px">
            <label>Email</label>
            <input name="email" type="email" required />
          </div>

          <div style="margin-top:10px">
            <label>Phone</label>
            <input name="phone" required />
          </div>

          <div style="margin-top:10px">
            <label>Address</label>
            <input name="address" required />
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>City</label>
              <input name="city" required />
            </div>
            <div>
              <label>Postal code</label>
              <input name="postal_code" required />
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Country</label>
            <input name="country" value="Norway" required />
          </div>

          <div style="margin-top:10px">
            <label>Message (optional)</label>
            <textarea name="message"></textarea>
          </div>

          <button class="btn" id="sendOrderBtn" type="submit" style="margin-top:14px">
            Send order
          </button>

          <div class="error" id="cartError">Your cart is empty. Go back and add products.</div>
          <div class="ok" id="vippsOk">Vipps payment started. You will be redirected…</div>
          <div class="error" id="vippsError"></div>
        </form>
      </section>

      <!-- Order summary -->
      <aside class="card">
        <h2 style="margin:0 0 10px;font-size:18px;">Order summary</h2>
        <div id="items" class="items"></div>
        <div class="total">
          <span>Total</span>
          <span><span id="total">0</span> NOK</span>
        </div>

        <div class="payBox">
          <button id="vippsBtn" class="btn vipps" type="button">
            Pay with Vipps
          </button>
          <div class="small">
            This will open Vipps for payment. After payment, you can still submit the shipping form above if needed.
          </div>
        </div>

        <button id="clearAll" class="btn secondary" type="button" style="margin-top:12px;width:100%">
          Clear all
        </button>
      </aside>
    </div>
  </main>

  <script>
    const CART_KEY = "amicbridge_cart_v1";

    function readCart() {
      try { return JSON.parse(localStorage.getItem(CART_KEY) || "[]"); }
      catch { return []; }
    }
    function writeCart(cart) {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
    }

    function buildHiddenFields(cart, total) {
      const summaryLines = cart.map((i) => {
        const line = (Number(i.qty||0) * Number(i.price||0));
        return `${i.name} | Qty: ${i.qty} | Size: ${i.size} | Color: ${i.color} | Line: ${line} NOK`;
      });

      document.getElementById("order_summary").value = summaryLines.join("\\n");
      document.getElementById("order_total_nok").value = String(total);
      document.getElementById("order_items_json").value = JSON.stringify(cart, null, 2);
    }

    function setVippsMsg(okText, errText) {
      const ok = document.getElementById("vippsOk");
      const err = document.getElementById("vippsError");
      if (okText) { ok.style.display = "block"; ok.textContent = okText; }
      else { ok.style.display = "none"; }
      if (errText) { err.style.display = "block"; err.textContent = errText; }
      else { err.style.display = "none"; }
    }

    function render() {
      const cart = readCart();
      const itemsEl = document.getElementById("items");
      const totalEl = document.getElementById("total");
      const cartError = document.getElementById("cartError");
      const sendBtn = document.getElementById("sendOrderBtn");
      const vippsBtn = document.getElementById("vippsBtn");

      itemsEl.innerHTML = "";
      let total = 0;

      cart.forEach((item, idx) => {
        const qty = Math.max(1, Number(item.qty || 1));
        const price = Number(item.price || 0);
        const line = qty * price;
        total += line;

        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            <strong>${item.name}</strong>
            <div class="meta">Size: ${item.size || "-"} · Color: ${item.color || "-"}</div>
            <div class="meta">Price: ${price} NOK</div>
          </div>

          <div class="controls">
            <div class="lineTotal">${line} NOK</div>
            <div class="qty" aria-label="Quantity">
              <button type="button" data-minus="${idx}">-</button>
              <div>${qty}</div>
              <button type="button" data-plus="${idx}">+</button>
            </div>
            <button class="remove" type="button" data-remove="${idx}">Remove</button>
          </div>
        `;

        itemsEl.appendChild(div);
      });

      totalEl.textContent = String(total);
      buildHiddenFields(cart, total);

      const empty = cart.length === 0;
      cartError.style.display = empty ? "block" : "none";
      sendBtn.disabled = empty;
      vippsBtn.disabled = empty;
    }

    // Event delegation for +/- and remove
    document.addEventListener("click", (e) => {
      const minus = e.target.closest("[data-minus]");
      const plus = e.target.closest("[data-plus]");
      const remove = e.target.closest("[data-remove]");

      if (!minus && !plus && !remove) return;

      const cart = readCart();

      if (minus) {
        const idx = Number(minus.getAttribute("data-minus"));
        if (cart[idx]) {
          cart[idx].qty = Math.max(1, Number(cart[idx].qty || 1) - 1);
          writeCart(cart);
          render();
        }
      }

      if (plus) {
        const idx = Number(plus.getAttribute("data-plus"));
        if (cart[idx]) {
          cart[idx].qty = Math.min(99, Number(cart[idx].qty || 1) + 1);
          writeCart(cart);
          render();
        }
      }

      if (remove) {
        const idx = Number(remove.getAttribute("data-remove"));
        if (cart[idx]) {
          cart.splice(idx, 1);
          writeCart(cart);
          render();
        }
      }
    });

    document.getElementById("clearAll").addEventListener("click", () => {
      writeCart([]);
      render();
    });

    // Vipps payment button
    document.getElementById("vippsBtn").addEventListener("click", async () => {
      setVippsMsg("", "");
      const cart = readCart();
      if (!cart.length) return;

      // total in NOK (your cart prices are NOK already)
      const total = cart.reduce((sum, i) => sum + (Number(i.price||0) * Number(i.qty||0)), 0);

      // Create an orderId (simple unique id)
      const orderId = `amic_${Date.now()}`;

      // store in form hidden fields too
      document.getElementById("vipps_order_id").value = orderId;
      document.getElementById("vipps_status").value = "started";

      const vippsBtn = document.getElementById("vippsBtn");
      vippsBtn.disabled = true;
      setVippsMsg("Vipps payment started. You will be redirected…", "");

      try {
        const res = await fetch("/.netlify/edge-functions/create-vipps-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            orderId,
            amount: total,
            currency: "NOK",
            items: cart,
            returnUrl: window.location.href
          }),
        });

        const data = await res.json();

        if (!res.ok) {
          document.getElementById("vipps_status").value = "failed";
          throw new Error(data?.error || "Vipps request failed");
        }

        // Your edge function should return { redirectUrl: "https://..." }
        if (!data.redirectUrl) {
          document.getElementById("vipps_status").value = "failed";
          throw new Error("Missing redirectUrl from Vipps function");
        }

        document.getElementById("vipps_status").value = "redirected";
        window.location.href = data.redirectUrl;
      } catch (err) {
        document.getElementById("vipps_status").value = "failed";
        setVippsMsg("", err.message || "Vipps error");
        vippsBtn.disabled = false;
      }
    });

    // Optional: clear cart after submit
    document.getElementById("orderForm").addEventListener("submit", () => {
      localStorage.setItem(CART_KEY, "[]");
    });

    render();
  </script>
</body>
</html>

