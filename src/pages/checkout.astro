---
const base = import.meta.env.BASE_URL;
const FORMSPREE_ACTION = "https://formspree.io/f/xzznjkvd";

// helper: always build correct URL (works on / and subfolders)
const img = (path) => `${base}${String(path || "").replace(/^\/+/, "")}`;
---

<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout — Amicbridge</title>

  <style>
    :root{
      --bg:#f7f6f4; --text:#151515; --muted:#6b6b6b; --border:#dedede; --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:24px 40px;display:flex;justify-content:space-between;align-items:center}
    a{color:var(--text);text-decoration:none}
    a:hover{text-decoration:underline}
    main{max-width:1100px;margin:0 auto;padding:0 40px 70px}
    h1{margin:16px 0 8px;font-size:34px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:start;margin-top:18px}
    .card{background:var(--card);border:1px solid var(--border);padding:16px}
    label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
    input,textarea{width:100%;padding:12px;border:1px solid var(--border);margin-top:6px;font-size:15px}
    textarea{min-height:90px;resize:vertical}
    .btn{padding:14px 12px;border:1px solid var(--text);background:var(--text);color:#fff;cursor:pointer;font-weight:700;width:100%}
    .btn.secondary{background:#fff;color:var(--text);border-color:var(--border);font-weight:600}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .error{color:#b42318;font-size:13px;margin-top:10px;display:none}
    .ok{color:#1a7f37;font-size:13px;margin-top:10px;display:none}

    .items{display:flex;flex-direction:column;gap:12px;margin-top:10px}
    .item{
      border-top:1px solid var(--border);
      padding-top:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
    }
    .item:first-child{border-top:0;padding-top:0}
    .item strong{display:block;font-size:16px;margin-bottom:4px}
    .meta{color:var(--muted);font-size:13px;line-height:1.35}
    .controls{
      display:flex; flex-direction:column; gap:8px; align-items:flex-end;
      min-width: 160px;
    }
    .qty{
      display:grid;
      grid-template-columns: 36px 44px 36px;
      border:1px solid var(--border);
      background:#fff;
    }
    .qty button{
      border:0;background:#fff;cursor:pointer;font-size:18px;padding:8px 0;
    }
    .qty div{
      display:flex;align-items:center;justify-content:center;font-weight:700;
      border-left:1px solid var(--border);border-right:1px solid var(--border);
    }
    .price{font-weight:800}
    .thumb{width:54px;height:54px;border:1px solid var(--border);background:#fff;object-fit:cover}
    .leftline{display:flex;gap:12px}
    .totals{margin-top:12px;border-top:1px solid var(--border);padding-top:12px}
    .totalsRow{display:flex;justify-content:space-between;margin:6px 0}
    .totalsRow strong{font-size:18px}
    .stack{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .small{font-size:12px;color:var(--muted);line-height:1.4}
    @media (max-width: 900px){
      header{padding:18px 18px}
      main{padding:0 18px 56px}
      .grid{grid-template-columns:1fr}
      .controls{align-items:stretch}
    }
  </style>
</head>

<body>
  <header>
    <a href={base}>← Back to shop</a>
    <a href={base} class="muted">Amicbridge</a>
  </header>

  <main>
    <h1>Checkout</h1>
    <div class="muted">Enter your details, review your order, then pay by card.</div>

    <div class="grid">
      <!-- LEFT: customer details (optional, and can still send to Formspree if you want) -->
      <section class="card">
        <h2 style="margin:0 0 10px;font-size:18px">Customer details</h2>

        <!-- You can keep Formspree for messages/order notes if you want -->
        <form id="detailsForm" action={FORMSPREE_ACTION} method="POST">
          <div class="row2">
            <div>
              <label for="name">Full name</label>
              <input id="name" name="name" autocomplete="name" required />
            </div>
            <div>
              <label for="email">Email</label>
              <input id="email" name="email" type="email" autocomplete="email" required />
            </div>
          </div>

          <div style="margin-top:12px">
            <label for="address">Address</label>
            <input id="address" name="address" autocomplete="street-address" required />
          </div>

          <div class="row2" style="margin-top:12px">
            <div>
              <label for="city">City</label>
              <input id="city" name="city" autocomplete="address-level2" required />
            </div>
            <div>
              <label for="zip">ZIP / Postal code</label>
              <input id="zip" name="zip" autocomplete="postal-code" required />
            </div>
          </div>

          <div style="margin-top:12px">
            <label for="notes">Order notes (optional)</label>
            <textarea id="notes" name="notes" placeholder="Size requests, delivery notes, etc."></textarea>
          </div>

          <!-- We’ll write the cart summary into this hidden field before submit -->
          <input type="hidden" id="cartSummary" name="cartSummary" value="" />
        </form>

        <div class="small" style="margin-top:12px">
          Payment is handled securely by Stripe. You won’t enter card details on this page.
        </div>
      </section>

      <!-- RIGHT: order summary -->
      <aside class="card">
        <h2 style="margin:0 0 10px;font-size:18px">Your order</h2>

        <div id="emptyCart" class="muted" style="display:none;margin-top:6px">
          Your cart is empty. Go back and add items.
        </div>

        <div id="items" class="items"></div>

        <div class="totals" id="totals" style="display:none">
          <div class="totalsRow">
            <span class="muted">Subtotal</span>
            <span id="subtotal">0</span>
          </div>
          <div class="totalsRow">
            <span class="muted">Shipping</span>
            <span id="shipping">Calculated at checkout</span>
          </div>
          <div class="totalsRow">
            <strong>Total</strong>
            <strong id="total">0</strong>
          </div>

          <div class="stack">
            <button class="btn" id="payBtn" type="button">Pay with card</button>
            <button class="btn secondary" id="sendBtn" type="button">Send order details (optional)</button>

            <p class="error" id="payErr"></p>
            <p class="ok" id="okMsg"></p>

            <div class="small">
              “Send order details” submits your info + cart to Formspree (optional).  
              “Pay with card” redirects to Stripe Checkout to complete payment.
            </div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // ---------- helpers ----------
    const fmt = (n) => {
      const num = Number(n || 0);
      return new Intl.NumberFormat("en-US", { style: "currency", currency: "NOK" }).format(num);
    };

    function readCart() {
      try {
        const raw = localStorage.getItem("cart");
        const parsed = JSON.parse(raw || "[]");
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function writeCart(cart) {
      localStorage.setItem("cart", JSON.stringify(cart));
    }

    // ---------- UI elements ----------
    const elItems = document.getElementById("items");
    const elEmpty = document.getElementById("emptyCart");
    const elTotals = document.getElementById("totals");
    const elSubtotal = document.getElementById("subtotal");
    const elTotal = document.getElementById("total");

    const payBtn = document.getElementById("payBtn");
    const sendBtn = document.getElementById("sendBtn");
    const payErr = document.getElementById("payErr");
    const okMsg = document.getElementById("okMsg");

    const detailsForm = document.getElementById("detailsForm");
    const cartSummaryInput = document.getElementById("cartSummary");

    function calcSubtotal(cart) {
      return cart.reduce((sum, it) => sum + (Number(it.price || 0) * Number(it.quantity || 1)), 0);
    }

    function render() {
      const cart = readCart();

      if (!cart.length) {
        elEmpty.style.display = "block";
        elTotals.style.display = "none";
        elItems.innerHTML = "";
        return;
      }

      elEmpty.style.display = "none";
      elTotals.style.display = "block";

      elItems.innerHTML = cart.map((it, idx) => {
        const name = it.name || it.id || "Item";
        const qty = Number(it.quantity || 1);
        const size = it.size ? `Size: ${it.size}` : "";
        const color = it.color ? `Color: ${it.color}` : "";
        const meta = [size, color].filter(Boolean).join(" • ");
        const lineTotal = Number(it.price || 0) * qty;
        const image = it.image ? it.image : "";

        return `
          <div class="item" data-idx="${idx}">
            <div class="leftline">
              ${image ? `<img class="thumb" src="${image}" alt="${name}">` : `<div class="thumb"></div>`}
              <div>
                <strong>${name}</strong>
                <div class="meta">${meta || "—"}</div>
                <div class="meta">Unit: ${fmt(it.price || 0)}</div>
              </div>
            </div>

            <div class="controls">
              <div class="qty">
                <button type="button" data-act="dec" aria-label="Decrease">−</button>
                <div>${qty}</div>
                <button type="button" data-act="inc" aria-label="Increase">+</button>
              </div>
              <div class="price">${fmt(lineTotal)}</div>
              <button type="button" class="btn secondary" style="padding:10px 12px" data-act="remove">Remove</button>
            </div>
          </div>
        `;
      }).join("");

      const sub = calcSubtotal(cart);
      elSubtotal.textContent = fmt(sub);
      elTotal.textContent = fmt(sub);

      // Update hidden field for Formspree
      cartSummaryInput.value = JSON.stringify(cart);
    }

    elItems.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const itemEl = e.target.closest(".item");
      if (!itemEl) return;

      const idx = Number(itemEl.dataset.idx);
      const act = btn.dataset.act;

      const cart = readCart();
      if (!cart[idx]) return;

      if (act === "inc") cart[idx].quantity = Number(cart[idx].quantity || 1) + 1;
      if (act === "dec") cart[idx].quantity = Math.max(1, Number(cart[idx].quantity || 1) - 1);
      if (act === "remove") cart.splice(idx, 1);

      writeCart(cart);
      render();
    });

    // ---------- actions ----------
    sendBtn?.addEventListener("click", () => {
      payErr.style.display = "none";
      okMsg.style.display = "none";

      // validate required fields first
      if (!detailsForm.reportValidity()) return;

      // Make sure cart summary is current
      cartSummaryInput.value = JSON.stringify(readCart());

      detailsForm.submit();
      okMsg.textContent = "Order details sent.";
      okMsg.style.display = "block";
    });

    payBtn?.addEventListener("click", async () => {
      payErr.style.display = "none";
      okMsg.style.display = "none";

      // validate required fields first (recommended)
      if (!detailsForm.reportValidity()) return;

      const cart = readCart();
      if (!cart.length) {
        payErr.textContent = "Your cart is empty.";
        payErr.style.display = "block";
        return;
      }

      // Build items for Stripe API: ONLY send safe identifiers (id, qty, size, color)
      const items = cart.map((it) => ({
        id: it.id,
        quantity: Number(it.quantity || 1),
        size: it.size || "",
        color: it.color || "",
      }));

      payBtn.disabled = true;

      try {
        const res = await fetch("/api/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            items,
            customer: {
              name: document.getElementById("name").value,
              email: document.getElementById("email").value,
              address: document.getElementById("address").value,
              city: document.getElementById("city").value,
              zip: document.getElementById("zip").value,
              notes: document.getElementById("notes").value,
            }
          }),
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Failed to start payment.");

        window.location.href = data.url; // Stripe Checkout redirect
      } catch (err) {
        payErr.textContent = err.message || "Payment error.";
        payErr.style.display = "block";
      } finally {
        payBtn.disabled = false;
      }
    });

    // initial render
    render();
  </script>
</body>
</html>

