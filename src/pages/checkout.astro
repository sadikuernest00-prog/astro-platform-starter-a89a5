---
const base = import.meta.env.BASE_URL;
const FORMSPREE_ACTION = "https://formspree.io/f/xzznjkvd";
const VIPPS_NUMBER = "92928373";
---

<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout — Amicbridge</title>

  <style>
    :root{--bg:#f7f6f4;--text:#151515;--muted:#6b6b6b;--border:#dedede;--card:#fff;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:24px 40px;display:flex;justify-content:space-between;align-items:center}
    a{color:var(--text);text-decoration:none}
    a:hover{text-decoration:underline}
    main{max-width:1100px;margin:0 auto;padding:0 40px 70px}
    h1{margin:16px 0 8px;font-size:34px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:start;margin-top:18px}
    .card{background:var(--card);border:1px solid var(--border);padding:16px;border-radius:12px}

    label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
    input,textarea{width:100%;padding:12px;border:1px solid var(--border);margin-top:6px;font-size:15px;border-radius:10px}
    textarea{min-height:90px;resize:vertical}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    .items{display:flex;flex-direction:column;gap:12px;margin-top:10px}
    .item{border-top:1px solid var(--border);padding-top:12px;display:grid;grid-template-columns:1fr auto;gap:12px}
    .item:first-child{border-top:0;padding-top:0}
    .meta{color:var(--muted);font-size:13px;line-height:1.35}
    .controls{display:flex;flex-direction:column;gap:8px;align-items:flex-end;min-width:160px}
    .qty{display:grid;grid-template-columns:36px 44px 36px;border:1px solid var(--border);background:#fff;border-radius:12px;overflow:hidden}
    .qty button{border:0;background:#fff;cursor:pointer;font-size:18px;padding:8px 0}
    .qty div{display:flex;align-items:center;justify-content:center;font-weight:900;border-left:1px solid var(--border);border-right:1px solid var(--border)}
    .thumb{width:54px;height:54px;border:1px solid var(--border);background:#fff;object-fit:cover;border-radius:12px}
    .leftline{display:flex;gap:12px}
    .price{font-weight:900}

    .totals{margin-top:12px;border-top:1px solid var(--border);padding-top:12px}
    .totalsRow{display:flex;justify-content:space-between;margin:6px 0}
    .stack{display:flex;flex-direction:column;gap:12px;margin-top:12px}

    .btn{padding:14px 12px;border:1px solid var(--text);background:var(--text);color:#fff;cursor:pointer;font-weight:900;width:100%;border-radius:12px}
    .btn.secondary{background:#fff;color:var(--text);border-color:var(--border)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .error{color:#b42318;font-size:13px;margin-top:10px;display:none}
    .ok{color:#1a7f37;font-size:13px;margin-top:10px;display:none}
    .small{font-size:12px;color:var(--muted);line-height:1.4}

    .step{border:1px solid var(--border);background:#fff;padding:14px;border-radius:12px}
    .badge{width:28px;height:28px;border-radius:999px;background:var(--text);color:#fff;font-weight:900;display:flex;align-items:center;justify-content:center}
    .stepTitle{display:flex;gap:10px;align-items:center;margin-bottom:8px}
    .vippsNumber{font-size:26px;font-weight:950;margin:6px 0 10px}

    .checkRow{display:flex;gap:10px;align-items:flex-start;margin-top:10px}
    .checkRow input{width:auto;margin-top:3px}

    @media (max-width:900px){
      header{padding:18px}
      main{padding:0 18px 56px}
      .grid{grid-template-columns:1fr}
      .controls{align-items:stretch}
    }
  </style>
</head>

<body>
  <header>
    <a href={`${base}`}>← Back to shop</a>
    <a href={`${base}`} class="muted">Amicbridge</a>
  </header>

  <main>
    <h1>Checkout</h1>
    <div class="muted">Step 1: Pay with Vipps • Step 2: Confirm payment and send order.</div>

    <div class="grid">
      <!-- LEFT: customer details -->
      <section class="card">
        <h2 style="margin:0 0 10px;font-size:18px">Customer details</h2>

        <form id="detailsForm" action={FORMSPREE_ACTION} method="POST">
          <div class="row2">
            <div>
              <label for="name">Full name</label>
              <input id="name" name="name" autocomplete="name" required />
            </div>
            <div>
              <label for="email">Email</label>
              <input id="email" name="email" type="email" autocomplete="email" required />
            </div>
          </div>

          <div style="margin-top:12px">
            <label for="address">Address</label>
            <input id="address" name="address" autocomplete="street-address" required />
          </div>

          <div class="row2" style="margin-top:12px">
            <div>
              <label for="city">City</label>
              <input id="city" name="city" autocomplete="address-level2" required />
            </div>
            <div>
              <label for="zip">ZIP / Postal code</label>
              <input id="zip" name="zip" autocomplete="postal-code" required />
            </div>
          </div>

          <div style="margin-top:12px">
            <label for="notes">Order notes (optional)</label>
            <textarea id="notes" name="notes" placeholder="Delivery notes, etc."></textarea>
          </div>

          <!-- Required Vipps confirmation info -->
          <div style="margin-top:12px">
            <label for="vippsRef">Vipps payment name or phone (required)</label>
            <input
              id="vippsRef"
              name="vippsRef"
              placeholder="Example: sara / 9xxxxxxx"
              required
            />
            <div class="small" style="margin-top:6px">
              This helps us match your Vipps payment to your order.
            </div>
          </div>

          <div class="checkRow">
            <input id="paidCheck" name="paidCheck" type="checkbox" />
            <div>
              <label for="paidCheck" style="display:block">I have paid with Vipps</label>
              <div class="small">
                You must pay first. Orders are processed after payment is received.
              </div>
            </div>
          </div>

          <!-- Hidden fields sent to Formspree -->
          <input type="hidden" id="cartSummary" name="cartSummary" value="" />
          <input type="hidden" id="orderTotal" name="orderTotal" value="" />
          <input type="hidden" id="vippsNumber" name="vippsNumber" value={VIPPS_NUMBER} />
        </form>
      </section>

      <!-- RIGHT: order summary + Vipps QR -->
      <aside class="card">
        <h2 style="margin:0 0 10px;font-size:18px">Your order</h2>

        <div id="emptyCart" class="muted" style="display:none;margin-top:6px">
          Your cart is empty.
        </div>

        <div id="items" class="items"></div>

        <div class="totals" id="totals" style="display:none">
          <div class="totalsRow">
            <span class="muted">Subtotal</span>
            <span id="subtotal">0</span>
          </div>
          <div class="totalsRow">
            <strong>Total</strong>
            <strong id="total">0</strong>
          </div>

          <div class="stack">
            <!-- STEP 1 -->
            <div class="step">
              <div class="stepTitle">
                <div class="badge">1</div>
                <div style="font-weight:950">Scan QR and pay with Vipps</div>
              </div>

              <div class="meta">Pay the Total to Vipps number:</div>
              <div class="vippsNumber">92928373</div>

              <div class="meta">Message: <strong>Your name + product</strong></div>

              <!-- QR CODE -->
              <div style="margin-top:12px">
                <img
                  src="/images/vipps-qr.jpg"
                  alt="Vipps QR"
                  style="width:290px;max-width:100%;border:1px solid #dedede;background:#fff;border-radius:16px"
                />
              </div>

              <div class="small" style="margin-top:10px">
                If you are on the same phone, open Vipps manually and send the total to <strong>92928373</strong>.
              </div>
            </div>

            <!-- STEP 2 -->
            <div class="step">
              <div class="stepTitle">
                <div class="badge">2</div>
                <div style="font-weight:950">Send order details</div>
              </div>

              <button class="btn secondary" id="sendBtn" type="button" disabled>
                Send order details
              </button>

              <p class="error" id="err"></p>
              <p class="ok" id="ok"></p>

              <div class="small">
                Button unlocks after you tick “I have paid with Vipps”.
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    const fmt = (n) =>
      new Intl.NumberFormat("en-US", { style: "currency", currency: "NOK" }).format(Number(n || 0));

    function readCart() {
      try { return JSON.parse(localStorage.getItem("cart") || "[]"); }
      catch { return []; }
    }
    function writeCart(c) { localStorage.setItem("cart", JSON.stringify(c)); }
    function subtotal(cart) {
      return cart.reduce((s, it) => s + Number(it.price || 0) * Number(it.quantity || 1), 0);
    }

    const elItems = document.getElementById("items");
    const elEmpty = document.getElementById("emptyCart");
    const elTotals = document.getElementById("totals");
    const elSubtotal = document.getElementById("subtotal");
    const elTotal = document.getElementById("total");

    const detailsForm = document.getElementById("detailsForm");
    const cartSummary = document.getElementById("cartSummary");
    const orderTotal = document.getElementById("orderTotal");

    const sendBtn = document.getElementById("sendBtn");
    const err = document.getElementById("err");
    const ok = document.getElementById("ok");

    const paidCheck = document.getElementById("paidCheck");
    const vippsRef = document.getElementById("vippsRef");

    function updateSendEnabled() {
      // Only enable if they confirmed payment
      sendBtn.disabled = !paidCheck.checked;
    }

    function render() {
      const cart = readCart();

      if (!cart.length) {
        elEmpty.style.display = "block";
        elTotals.style.display = "none";
        elItems.innerHTML = "";
        cartSummary.value = "[]";
        orderTotal.value = "0";
        sendBtn.disabled = true;
        return;
      }

      elEmpty.style.display = "none";
      elTotals.style.display = "block";

      elItems.innerHTML = cart.map((it, idx) => {
        const name = it.name || it.id || "Item";
        const qty = Number(it.quantity || 1);
        const meta = [
          it.size ? `Size: ${it.size}` : "",
          it.color ? `Color: ${it.color}` : "",
        ].filter(Boolean).join(" • ") || "—";

        const lineTotal = Number(it.price || 0) * qty;
        const image = it.image || "";

        return `
          <div class="item" data-idx="${idx}">
            <div class="leftline">
              ${image ? `<img class="thumb" src="${image}" alt="${name}">` : `<div class="thumb"></div>`}
              <div>
                <strong>${name}</strong>
                <div class="meta">${meta}</div>
                <div class="meta">Unit: ${fmt(it.price || 0)}</div>
              </div>
            </div>

            <div class="controls">
              <div class="qty">
                <button type="button" data-act="dec">−</button>
                <div>${qty}</div>
                <button type="button" data-act="inc">+</button>
              </div>
              <div class="price">${fmt(lineTotal)}</div>
              <button type="button" class="btn secondary" style="padding:10px 12px" data-act="remove">Remove</button>
            </div>
          </div>
        `;
      }).join("");

      const sub = subtotal(cart);
      elSubtotal.textContent = fmt(sub);
      elTotal.textContent = fmt(sub);

      cartSummary.value = JSON.stringify(cart);
      orderTotal.value = String(sub);

      updateSendEnabled();
    }

    elItems.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const itemEl = e.target.closest(".item");
      if (!itemEl) return;

      const idx = Number(itemEl.dataset.idx);
      const act = btn.dataset.act;

      const cart = readCart();
      if (!cart[idx]) return;

      if (act === "inc") cart[idx].quantity = Number(cart[idx].quantity || 1) + 1;
      if (act === "dec") cart[idx].quantity = Math.max(1, Number(cart[idx].quantity || 1) - 1);
      if (act === "remove") cart.splice(idx, 1);

      writeCart(cart);
      render();
    });

    paidCheck.addEventListener("change", () => {
      err.style.display = "none";
      ok.style.display = "none";
      updateSendEnabled();
    });

    sendBtn.addEventListener("click", () => {
      err.style.display = "none";
      ok.style.display = "none";

      const cart = readCart();
      if (!cart.length) {
        err.textContent = "Your cart is empty.";
        err.style.display = "block";
        return;
      }

      if (!paidCheck.checked) {
        err.textContent = "Please pay with Vipps first and tick “I have paid with Vipps”.";
        err.style.display = "block";
        return;
      }

      // Validate the whole form (includes vippsRef required)
      if (!detailsForm.reportValidity()) return;

      cartSummary.value = JSON.stringify(cart);
      orderTotal.value = String(subtotal(cart));

      detailsForm.submit();
      ok.textContent = "Order details sent. Thank you! We will confirm your Vipps payment and ship.";
      ok.style.display = "block";
    });

    render();
  </script>
</body>
</html>
